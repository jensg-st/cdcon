description: A simple 'no-op' state that returns 'Hello world!'
functions:
- id: gcloud-build
  image: gcr.io/direktiv/apps/gcloud:1.0
  type: knative-workflow
- id: run-tests
  type: subflow
  workflow: scan

# wait for gitea event. type is 'noncompliant' because gitea does not send cloudevents
start:
  type: event
  state: start
  event:
    type: noncompliant
states:

# transform input data from gitea webhook
- id: start
  type: noop
  log: jq(.)
  transform:
    url: jq(.noncompliant.data.repository.clone_url)
    image: jq(.noncompliant.data.repository.clone_url | split("/")[-1] | split(".")[0])
    name: jq(.noncompliant.data.repository.full_name)
  transition: build

# building the application
- id: build
  type: action
  action:
    function: gcloud-build
    secrets: ["gcloud-key", "gcloud-project", "gcloud-user"]
    files:
    - key: cloudbuild-release.steps
      scope: workflow
      as: cloudbuild.yml
    input:
      key: jq(.secrets."gcloud-key" | @base64 ) 
      account: jq(.secrets."gcloud-user")
      project: jq(.secrets."gcloud-project")
      commands:
      - command: git clone jq(.url) app
      - command: gcloud builds submit app --config cloudbuild.yml --format=json --substitutions _REPO=jq(.image)
  transition: run-test
  
# run test subflow
- id: run-test
  type: action
  action:
    function: run-tests
    input: 
      image: eu.gcr.io/direktiv/jq(.image)
      name: jq(.name)
  catch: 
  - error: "detectedVulnerabilities"
    transition: issue

- id: issue
  type: noop
  log: Build was successful but tests failed